---
title: "Tufte样式"
author: "JJ Allaire，谢益辉"
date: '`r Sys.Date()`'
output:
  tufte::tufte_html: default
  self_contained: yes
d3: yes
bibliography: skeleton.bib
link-citations: yes
ctex: yes
subtitle: 一个R Markdown实现
biblio-title: 参考文献
---
<meta charset="utf-8">

```{r setup, include=FALSE}
library(tufte)
# tufte版本变化之后更新knitr缓存
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)
```

# 引言

Tufte样式在Edward Tufte的书以及物理学家费曼的教科书很常见，它的一个显著特点就是边栏的使用。例如脚注和边栏注解，以及放在边栏里的小型插图。Tufte样式在LaTeX和HTML/CSS中都有实现^[参见Github库[tufte-latex](https://github.com/tufte-latex/tufte-latex)和 [tufte-css](https://github.com/edwardtufte/tufte-css)]。我们将这两种实现都纳入了[**tufte**包](https://github.com/rstudio/tufte)。若需要LaTeX/PDF输出，使用输出格式`tufte_handout`即可，类似地，`tufte_book`可以用来输出PDF书，`tufte_html`生成HTML网页。这些输出格式可以在YAML元数据中指定，或者传给`rmarkdown::render()`函数。若对**rmarkdown**包不熟悉，可参见 @R-rmarkdown。

```yaml
---
title: "一个Tufte样式示例"
author: "张三"
ctex: yes
output:
  tufte::tufte_handout:
    latex_engine: xelatex
  tufte::tufte_html: default
---
```

# 章节标题

Tufte样式不主张太深的章节目录，一般仅仅使用一级标题（Markdown中用一个井号`#`）和二级标题（两个井号）。

# 插图

## 边栏插图

插图在Tufte的书中非常常见，我们可以使用三种插图：边栏图、全宽图、主栏图。先说边栏图：使用**knitr**代码段选项`fig.margin = TRUE`即可将图形放置在边栏中，如：

```{r fig-margin, fig.margin = TRUE, fig.cap = "MPG与horsepower两个变量的散点图；颜色代表自动挡或手动挡。", fig.width=3.5, fig.height=3.5, cache=TRUE}
library(ggplot2)
mtcars2 <- mtcars
mtcars2$am <- factor(
  mtcars$am, labels = c('automatic', 'manual')
)
ggplot(mtcars2, aes(hp, mpg, color = am)) +
  geom_point() + geom_smooth() +
  theme(legend.position = 'bottom')

```

```{r ,include=FALSE}
library(wordcloud2)
#source("R/wordCloud.R",encoding = "UTF-8")
wordcloud2(demoFreqC,size=0.3)

```


```{r results='asis', echo=FALSE,fig.width=6,fig.height=5}

wd=wordcloud2(demoFreqC,size=0.3,widgetsize = c(500,400))
htmlwidgets::saveWidget(wd, file = './teste_widget.html', selfcontained = F)
cat(readLines("teste_widget.html",encoding = "UTF-8")[c(13:17)])
```

<script src="teste_widget_files/htmlwidgets/htmlwidgets.js"></script>
<link href="teste_widget_files/wordcloud2/wordcloud.css" rel="stylesheet" />
<script src="teste_widget_files/wordcloud2/wordcloud2-all.js"></script>
<script src="teste_widget_files/wordcloud2/hover.js"></script>
<script src="teste_widget_files/wordcloud2-binding/wordcloud2.js"></script>
<div id="htmlwidget_container">
  <div id="htmlwidget-2786" style="width:500px;height:400px;" class="wordcloud2 html-widget"></div>
</div>
<script type="application/json" data-for="htmlwidget-2786">{"x":{"word":["数据","统计","用户","模型","分析","数据分析","大数据","研究","信息","大学","语言","方法","问题","会议","数据科学","学习","可能","中国","科学","计算","网络","公司","预测","应用","变量","时间","选择","广告","主要","行业","关键","系统","影响","估计","北京","品牌","学院","城市","误差","处理","产品","分布","过程","相关","搜索","训练","方面","重要","函数","行为","技术","有限","户的","市场","提供","关系","工作","非常","利用","机器","可视","联网","COS","本文","业务","文本","比较","得到","推荐","样的","演讲","介绍","微博","计之","统计之都","实际","工具","现在","用户的","可视化","报告","关注","器学习","方式","样本","能够","情况","机器学习","沙龙","data","学家","已经","音乐","有限公司","中心","发展","算法","老师","表示","型的","概率","互联","管理","言会","互联网","语言会","客户","特征","结构","语言会议","一种","企业","喜欢","大的","的是","的分","社交","金融","到了","用的","先生","量的","参数","学生","具体","发现","实现","教授","包括","指标","分类","平均","mathbf","之间","博士","是一个","建模","聚类","领域","兴趣","这种","本次","回归","要的","告主","购买","会场","上的","广告主","的研","代码","矩阵","科技","销量","间的","的问","两个","的问题","天气","每个","内容","定义","的统","模型的","的研究","frac","作者","到的","并不","有一","的用","的统计","解决","面的","之后","平台","标签","简单","这一","多的","手机","是我","销售","文章","消费","软件","信用","开发","更多","http","一步","描述","是否","最后","的方法","认为","高端","同的","存在","的用户","评论","基础","深度","的信","代表","复杂","我的","获得","也是","挖掘","的工","程中","纪要","一定","主题","单位","广州","们可","来的","科学家","了解","展示","随机","效果","数学","线性","参会","学的","报名","行了","支持","有效","直接","mathcal","在这","对应","当时","的模","价值","基本","新的","目前","营销","论文","不同的","交易","我们可","指数","方向","获取","记录","都是","定的","每一","过程中","们可以","出现","数据科学家","知道","第二","策略","美国","考虑","这样的","业的","传统","希望","的时候","相对","程度","自己的","说明","进行了","采用","应的","时代","社交网","网站","这是","人员","在一","届中国","的预","目标","社交网络","是不","服务","的应","者的","觉得","评价","变化","建立","我们可以","更加","的应用","的模型","看到","风险","应该","的结","知识","竞争","结合","贝叶斯","产生","帮助","测试","理解","组织","经济","他的","具有","出了","容易","成为","用于","准确","的一个","能力","趋势","银行","性的","的基","商业","讨论","一下","世界","之间的","人的","包含","数的","最大","系数","是在","里面","专业","成本","计算机","财经","驾驶","一次","了一个","工程","我们的","理论","生成","的信息","的重","研究中","简历","项目","三个","上海","也可","分享","成功","有很","的关键","其实","医疗","快速","投资","最近","渠道","的大","规模","进一","违约","不能","优化","后的","影响力","推断","生物","的预测","预测误差","业界","以看","几个","嘉宾","程序","角度","训练集","进一步","需求","假设","可以看","深度学习","的时间","设计","功能","推广","案例","模型选","的可","的概","节点","行的","个数","之前","因素","模型选择","环境","的影","解释","起来","高端车","model","text","东西","以下","另一","形式","智能","的文","重要的","参考","增加","的发","的影响","背景","车险","分词","化的","学术","布的","核心","的变","经大","通常","介绍了","原因","可能也","控制","机构","法的","王小宁","生的","的相","自然","论坛","财经大学","车辆","验证","为一","导致","征信","析的","的主","的实","而不","速度","也喜欢","人群","分析的","大量","实验","年的","找到","抽样","统的","编辑","联系","cdot","spark","中山","例子","北京大","司机","就可","得分","提出","效率","数据挖","方差","无觅","是对","真实","下来","个问","北京大学","历史","图形","就可以","带来","您可能也喜欢","提高","数据挖掘","显示","本的","趣的","事情","地区","建议","成了","提升","数据可","数据时","日期","朋友","社会","观测","评估","量化","个问题","也可以","人民","保险","判断","对数","工业","文件","标准","的学","的工作","研究中心","神经","系列","让我","xgboost","下面","不会","体的","所示","提供了","汽车","的广","的特","经验","驱动","err","hat","医学","媒体","据中","的分析","的推","的最","ggtree","不断","个体","也不","人民大学","位置","出的","基金","大数据的","来越","消费者","爆发","的机","的高","益辉","编程","表现","alpha","下载","中文","们将","会有","商务","国人","学研究","完成","度的","数据中","每周","特别","的过","神经网络","第三","计分","词的","阶段","驶行为","做一","做的","分的","埃博拉","多个","是有","来源","现了","的关键词","越来越","驾驶行为","高的","中国人","会者","兴趣的","好友","我们将","挑战","数据进","有很多","气象","注意","统计分","语言的","超过","金额","一点","一起","下的","中国人民","举办","交流","他们的","向量","在的","大小","学统计","山大","总结","意义","数据进行","数量","未来","比例","沙龙第","的个","的发展","的情","的方式","的过程","示了","科技有","计的","资料","中国人民大学","中山大学","分为","参会者","发布","国内","家的","展现","感兴趣","扩展","抓取","损失","排名","最终","每周精选","游戏","生活","科技有限公司","质量","题的","也就","今天","基因","收集","改进","数据可视化","是这","模式","的不","的估","的广告","的标","目的","相应","类别","统计分析","谢益辉","CV","们在","力的","华南","引擎","新闻","是最","概念","欢迎","点击","的交","的概率","的重要","监测","给出","综合","规则","距离","autoplot","不可","了这","你的","做了","关的","制造","同样","增长","完全","接口","操作","数据时代","更多的","次会议","电子","的优","的行","移动","调整","酒精性饮料","重复","一方","一致","习的","似然","健康","准则","单的","博文","合理","大数据时","实践","对应的","属性","年龄","很大","很好","接下","提取","现的","百度","的东","的关系","的理","的结果","空间","线性模型","要求","达到","app","上面","个用","了很","值的","分布的","国际","在大","在线","地方","域的","基础上","大数据时代","学习的","忠诚","思考","接下来","效的","是很","曲线","条件","用了","界的","的目","的解","议的","识别","资源","UBI","个性","为我","国家","它的","性化","正态","毕业","流程","的东西","的估计","的第","种方","究的","重点","问题的","python","主办","也有","创意","发生","思路","整个","更好","有一个","有可","本科","来看","死亡","流行","理学","的各","相关的","研究的","红包","组合","结构化","网络中","自动","行业的","表明","这就","bootstrap","一直","个用户","了数","交通","以用","会议的","作用","做出","合作","天津","学科","对数据","就会","广东","拟合","整体","方面的","本次会议","每一个","注册","点的","疫情","的事","的内","的地","简单的","观察","访谈","这两","进行分","阅读","BIC","个性化","个方","交叉","吸引","完整","层面","巨大","态分布","投放","是什么","最小","本数","极大","涉及","深圳","的基础","真正","类似","编码","让我们","QQ","也就是","保证","保费","创业","前的","区域","国的","在中","对用户","感觉","所有的","拥有","探索","是因","最好","机会","正态分布","水平","独立","理的","的思","的成","的计","的语","研究院","类型"],"freq":[2304,1413,855,846,773,750,650,547,543,497,430,428,426,411,401,385,373,366,359,359,350,341,314,306,280,277,255,254,239,238,232,228,226,222,220,217,214,213,213,210,209,209,208,200,199,196,193,189,187,187,180,180,179,178,178,177,176,174,171,171,170,169,168,168,167,167,167,163,163,162,162,159,159,159,157,156,156,156,156,154,153,151,151,150,150,150,149,148,148,147,147,147,147,145,143,143,142,142,142,141,140,139,138,138,137,137,136,135,135,135,134,134,134,134,134,132,132,132,131,131,130,130,129,129,128,128,128,128,127,127,126,126,125,125,124,124,123,123,123,122,122,121,120,120,119,119,118,117,117,117,116,116,116,116,116,115,114,114,113,113,112,112,112,111,111,110,110,110,110,110,110,110,110,110,109,108,108,108,108,107,107,107,107,106,106,106,105,105,105,104,104,104,104,104,104,104,104,103,103,103,103,102,102,102,101,101,101,101,100,100,100,100,100,99,98,98,98,97,97,97,96,96,96,95,95,95,94,94,94,94,93,93,93,92,92,92,92,92,91,91,91,91,91,91,90,90,90,90,90,90,90,90,89,89,89,88,88,88,88,88,88,88,88,88,87,87,87,87,87,87,87,87,87,87,86,86,86,86,86,85,85,85,85,85,85,84,84,84,84,84,84,83,83,83,83,83,83,83,83,82,82,82,82,82,82,81,81,81,81,81,81,80,80,80,80,80,80,79,79,79,79,79,78,78,77,77,76,76,76,76,76,76,76,76,75,75,74,74,74,74,74,73,73,73,73,73,73,73,73,73,73,73,72,72,72,72,72,72,72,71,71,71,71,71,71,71,71,71,71,70,70,70,70,70,70,70,70,69,69,69,69,69,69,69,69,69,68,68,68,68,68,67,67,67,67,67,67,67,67,66,66,66,66,66,66,66,66,66,65,65,65,65,65,65,65,65,65,64,64,64,64,64,64,63,63,63,63,63,63,63,63,62,62,62,62,62,62,62,62,62,62,62,62,62,62,61,61,61,61,61,61,61,61,60,60,60,60,60,60,60,60,60,60,60,59,59,59,59,59,59,59,59,59,59,59,59,59,59,59,58,58,58,58,58,58,58,58,58,58,58,58,58,57,57,57,57,57,57,57,57,57,57,57,57,57,56,56,56,56,56,56,56,56,56,56,56,56,56,56,56,55,55,55,55,55,55,55,55,55,55,55,54,54,54,54,54,54,54,54,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,51,51,51,51,51,51,51,51,51,51,51,51,50,50,50,50,50,50,50,50,50,50,50,50,50,50,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,47,47,47,47,47,47,47,47,47,47,47,47,47,47,47,47,47,46,46,46,46,46,46,46,46,46,46,46,46,46,46,46,46,46,46,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,39,39,39,39,39,39,39,39,39,39,39,39,39,39,39,39,39,39,39,39,39,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38],"fontFamily":"Segoe UI","fontWeight":"bold","color":"random-dark","minSize":0,"weightFactor":0.0234375,"backgroundColor":"white","gridSize":0,"minRotation":-0.785398163397448,"maxRotation":0.785398163397448,"shuffle":true,"rotateRatio":0.4,"shape":"circle","ellipticity":0.65,"figBase64":null,"hover":null},"evals":[],"jsHooks":[]}
</script>
<script type="application/htmlwidget-sizing" data-for="htmlwidget-2786">{"viewer":{"width":500,"height":400,"padding":0,"fill":false},"browser":{"width":500,"height":400,"padding":0,"fill":false}}
</script>




注意我们使用代码段选项`fig.cap`设定了图的标题。当然我们也可以设置图的长宽。
```{r test ,results='asis',echo=FALSE}
res = contourLines(volcano)
xy = paste(unlist(lapply(res, function(z) {
  xs = paste(round(z$x, 3), collapse = ',')
  ys = paste(round(z$y, 3), collapse = ',')
  sprintf('{\n  "x": [%s],\n  "y": [%s]\n}', xs, ys)
})), collapse = ', \n')
cat('<script>',
    sprintf('var data = [%s]', xy),
    '</script>',
    sep = '\n')
```

<script src="http://d3js.org/d3.v2.min.js">
</script>

<div id="volcano" style="text-align: center;"></div>

<script type="text/javascript">
var width = 500, height = 300;

var x = d3.scale.linear()
    .domain([0, 1])
    .range([0, width]);

var y = d3.scale.linear()
    .domain([0, 1])
    .range([height, 0]);

var line = d3.svg.line()
    .x(function(d) { return x(d.x); })
    .y(function(d) { return y(d.y); });

var svg = d3.select("#volcano").append("svg")
    .attr("width", width)
    .attr("height", height)
    .selectAll("path")
      .data(data.map(function(d) {
        return d3.range(d.x.length).map(function(i) {
          return {x: d.x[i], y: d.y[i]};
        });
      }))
    .enter().append("svg:path")
      .attr("d", line)
      .on("mouseover", function(d, i) {
        d3.select(this).style("stroke", "yellow");
      })
      .on("mouseout", function(d, i) {
        d3.select(this).style("stroke", "darkgreen");
      })
      .style("fill", "none")
      .style("stroke", "darkgreen")
      .style("stroke-width", 0)
      .transition()
      .duration(10000)
      .style("stroke-width", 2);
</script>


<script type="text/javascript" src="./CSS/JS/echarts.js"></script>

<div id="main" style="width: 600px;height:400px;"></div>
<script type="text/javascript">
var myChart=echarts.init(document.getElementById("main"));
option = {
    title: {
        text: 'ECharts 入门示例'
    },
    tooltip: {},
    legend: {
        data:['销量']
    },
    xAxis: {
        data: ["衬衫","羊毛衫","雪纺衫","裤子","高跟鞋","袜子"]
    },
    yAxis: {},
    series: [{
        name: '销量',
        type: 'bar',
        data: [5, 20, 36, 10, 10, 20]
    }]
};
  myChart.setOption(option);
</script>


## 任意边栏内容

事实上我们可以在边栏中放置除了图之外的内容，此时我们不再使用```` ```{r} ````写代码段，而是用```` ```{marginfigure} ````。例如右边有一个微积分第一基本定理。

```{marginfigure}
根据微积分第一基本定理我们知道，对$x \in [a, b]$有
$$\frac{d}{dx}\left( \int_{a}^{x} f(u)\,du\right)=f(x).$$
```

为了文本内容的可移植性（同样的内容可以生成HTML和LaTeX文档），我们建议边栏中不要放置太复杂的内容，简单的加粗、倾斜都没有问题，但不建议在边栏中使用列表、参考文献等内容。

## 全宽插图

代码段选项`fig.fullwidth = TRUE`可以使得一幅图占用全部页宽，例如：

```{r fig-fullwidth, fig.width = 10, fig.height = 2, fig.fullwidth = TRUE, fig.cap = "一幅全宽图形。", warning=FALSE, cache=TRUE}
ggplot(diamonds, aes(carat, price)) + geom_smooth() +
  facet_grid(~ cut)
```

其它和图形有关的代码段选项仍然可以使用，一般情况下，全款图形的`fig.width`选项会较大，而`fig.height`相对较小。上图的尺寸是$10 \times 2$英寸.

## 主栏插图

默认情况下，R代码段生成的图形放置在主栏里，其标题放在边栏中，例如：

```{r fig-main, fig.cap = "一幅主栏插图。", cache=TRUE}
ggplot(diamonds, aes(cut, price)) + geom_boxplot()
```

# 边栏附注

Tufte样式的文档中，脚注会被自动转换为边栏附注^[这里本来是一个脚注]。脚注是带编号的，另一种边栏附注是不带编号的，这种附注需要用**tufte**包中的R函数`margin_note()`在**knitr**行内代码中生成。`r margin_note("这是一个边栏附注，它没有编号。")`与边栏插图一样，边栏附注中我们也不建议写太复杂的内容，通常只是一句简单的文字。

# 参考文献

HTML输出中，参考文献默认也放在边栏中。例如这里我们可以引用[@R-base]。这个功能需要在YAML元数据中设置`link-citations: yes`，而且`pandoc-citeproc`程序的版本应该至少是0.7.2。若这两个条件不满足，参考文献会被放在文档末尾。

# 表格

我们可以用**knitr**包中的`kable()`函数生成简单的表格。HTML输出中表格的标题也会被放在边栏中。

```{r}
knitr::kable(
  mtcars[1:6, 1:6], caption = 'mtcars数据的前几行。'
)
```

# 引文

Markdown语法使用`>`来生成引文，如果需要在引文下面用行内代码以及`quote_footer()`函数加上一句引文来源，例如：

> "多亏了我的律师，要不然我现在还在牢里。两个人一起挖确实比一个人快很多啊。"
>
> `r tufte::quote_footer('--- Joe Martin')`

如果不用这个函数的话，引文底部的话只是一个普通段落：

> "伟人论道，凡人论事，小人论酒。"
>
> --- Fran Lebowitz

# 响应式页面

这个包生成的HTML页面是响应式的：如果页宽小于760像素，边栏内容会自动隐藏。此时我们可以点击脚注的序号显示它，其它边栏附注则可以通过点击圆圈加号的符号显示。

# 结语

希望诸位喜欢R Markdown的超级简洁性，同时我们感谢Tufte-CSS和Tufte-LaTeX项目的作者们，没有他们的辛勤劳动，就没有这个**tufte**包。这份文档的R Markdown源文档可以在[Github上找到](https://github.com/rstudio/tufte/raw/master/inst/rmarkdown/templates/tufte_ctex/skeleton/skeleton.Rmd)，或者直接使用RStudio菜单`File -> New File -> R Markdown -> From Template`新建一个文档，或直接从R里面打开这个Rmd文件：

```{r eval=FALSE}
file.edit(
  tufte:::template_resources(
    'tufte_ctex', '..', 'skeleton', 'skeleton.Rmd'
  )
)
```

```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('base', 'rmarkdown'), file = 'skeleton.bib')
```
